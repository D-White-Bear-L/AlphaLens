# æ–°é—»æº¯æºç³»ç»Ÿ (News Trace System)

ä¸€ä¸ªåŸºäº AI Agent çš„æ™ºèƒ½æ–°é—»æº¯æºç³»ç»Ÿï¼Œé€šè¿‡å¤šè½®è¿­ä»£çš„æ·±åº¦æœç´¢å’Œå†…å®¹æå–ï¼Œè‡ªåŠ¨è¿½è¸ªæ–°é—»æ¥æºã€æ„å»ºæ—¶é—´çº¿ã€åˆ†æå› æœå…³ç³»ï¼Œå¹¶ç”ŸæˆçŸ¥è¯†å›¾è°±ã€‚

## ğŸ“‹ ç›®å½•

- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [Agent è®¾è®¡](#agent-è®¾è®¡)
- [å·¥å…·è®¾è®¡](#å·¥å…·è®¾è®¡)
- [ç»“æ„åŒ–è¾“å‡º](#ç»“æ„åŒ–è¾“å‡º)
- [çˆ¬è™«ç‰¹æ€§](#çˆ¬è™«ç‰¹æ€§)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [API æ–‡æ¡£](#api-æ–‡æ¡£)
- [å‰ç«¯ç•Œé¢](#å‰ç«¯ç•Œé¢)

## é¡¹ç›®æ¦‚è¿°

æ–°é—»æº¯æºç³»ç»Ÿæ˜¯ä¸€ä¸ªæ™ºèƒ½åŒ–çš„æ–°é—»æ¥æºè¿½è¸ªå’Œåˆ†æå¹³å°ï¼Œèƒ½å¤Ÿï¼š

- ğŸ” **æ·±åº¦æº¯æº**: é€šè¿‡å¤šè½®è¿­ä»£æœç´¢å’Œå†…å®¹æå–ï¼Œæ·±å…¥è¿½è¸ªæ–°é—»æ¥æº
- ğŸ“Š **ç»“æ„åŒ–åˆ†æ**: è‡ªåŠ¨æå–æ—¶é—´çº¿ã€å› æœå…³ç³»ã€çŸ¥è¯†å›¾è°±ç­‰å¤šç»´åº¦ä¿¡æ¯
- ğŸ•·ï¸ **æ™ºèƒ½çˆ¬è™«**: ä½¿ç”¨ Playwright å¤„ç†åŠ¨æ€ç½‘é¡µï¼Œæå–å®Œæ•´å†…å®¹
- ğŸ¯ **å¯é…ç½®æ·±åº¦**: æ”¯æŒ 1-4 çº§æº¯æºæ·±åº¦æ§åˆ¶ï¼Œå¹³è¡¡é€Ÿåº¦ä¸å‡†ç¡®æ€§
- ğŸ“ˆ **å¯è§†åŒ–å±•ç¤º**: å‰ç«¯æä¾›çŸ¥è¯†å›¾è°±ã€å±‚çº§å›¾ã€æ—¶é—´çº¿ç­‰ä¸°å¯Œçš„å¯è§†åŒ–

## æŠ€æœ¯æ ˆ

### åç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **FastAPI** | >=0.104.0 | å¼‚æ­¥ Web æ¡†æ¶ï¼Œæä¾› RESTful API |
| **mira** | latest | LLM å·¥å…·è°ƒç”¨æ¡†æ¶ï¼Œæ”¯æŒç»“æ„åŒ–è¾“å‡º |
| **Playwright** | >=1.40.0 | æ— å¤´æµè§ˆå™¨ï¼Œå¤„ç†åŠ¨æ€ç½‘é¡µçˆ¬å– |
| **Pydantic** | >=2.0.0 | æ•°æ®éªŒè¯å’Œç»“æ„åŒ–è¾“å‡ºæ¨¡å‹ |
| **httpx** | >=0.24.0 | å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ |
| **loguru** | >=0.7.0 | ç»“æ„åŒ–æ—¥å¿—è®°å½• |
| **Serper API** | - | Google æœç´¢ API æœåŠ¡ |

### å‰ç«¯æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Vue 3** | ^3.5.24 | æ¸è¿›å¼å‰ç«¯æ¡†æ¶ |
| **Element Plus** | ^2.12.0 | Vue 3 UI ç»„ä»¶åº“ |
| **Vite** | ^7.2.4 | å¿«é€Ÿæ„å»ºå·¥å…· |
| **vis.js** | - | çŸ¥è¯†å›¾è°±å’Œå±‚çº§å›¾å¯è§†åŒ– |
| **axios** | ^1.13.2 | HTTP å®¢æˆ·ç«¯ |
| **vue-router** | ^4.6.4 | è·¯ç”±ç®¡ç† |

## æ ¸å¿ƒç‰¹æ€§

### 1. å¤šè½®è¿­ä»£æ·±åº¦æº¯æº

ç³»ç»Ÿé‡‡ç”¨å¤šé˜¶æ®µå·¥ä½œæµç¨‹ï¼š

```
é˜¶æ®µ 1: åˆå§‹æœç´¢
  â†“ GoogleSearch æ‰¾åˆ°åˆå§‹æ¥æº
é˜¶æ®µ 2: æ·±åº¦å†…å®¹æå–
  â†“ WebScraper æŠ“å–è¯¦ç»†å†…å®¹ï¼ˆè‡³å°‘ 5-10 ä¸ª URLï¼‰
é˜¶æ®µ 3: å¤šè½®è°ƒæŸ¥
  â†“ åŸºäºæå–å†…å®¹è¿›è¡Œæ›´ç²¾ç¡®çš„æœç´¢
  â†“ ç»§ç»­æŠ“å–ç›¸å…³ URL
é˜¶æ®µ 4: æ·±åº¦åˆ†æ
  â†“ æ„å»ºæ—¶é—´çº¿ã€å› æœå…³ç³»ã€çŸ¥è¯†å›¾è°±
```

### 2. å¯é…ç½®æº¯æºæ·±åº¦

æ”¯æŒ 1-4 çº§æ·±åº¦æ§åˆ¶ï¼š

- **æ·±åº¦ 1 (æµ…å±‚)**: å¿«é€Ÿæœç´¢ï¼Œé€‚åˆç®€å•æŸ¥è¯¢
- **æ·±åº¦ 2 (ä¸­ç­‰)**: é»˜è®¤æ·±åº¦ï¼Œå¹³è¡¡é€Ÿåº¦ä¸å‡†ç¡®æ€§
- **æ·±åº¦ 3 (æ·±å±‚)**: æ›´å…¨é¢çš„æœç´¢å’Œåˆ†æ
- **æ·±åº¦ 4 (ææ·±)**: æœ€å…¨é¢çš„æº¯æºï¼Œé€‚åˆå¤æ‚ä¸»é¢˜

### 3. ä»»åŠ¡ç®¡ç†ä¸å–æ¶ˆ

- å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œæ”¯æŒé•¿æ—¶é—´è¿è¡Œ
- å®æ—¶è¿›åº¦æ›´æ–°ï¼ˆ0-100%ï¼‰
- å‰ç«¯å¯éšæ—¶å–æ¶ˆä»»åŠ¡ï¼Œåç«¯ç«‹å³å“åº”
- ä»»åŠ¡çŠ¶æ€æŒä¹…åŒ–ï¼Œæ”¯æŒé¡µé¢åˆ·æ–°åæ¢å¤

### 4. ç»“æ„åŒ–è¾“å‡º

ä½¿ç”¨ Pydantic å’Œ LLMJson å®ç°å¼ºç±»å‹ç»“æ„åŒ–è¾“å‡ºï¼š

- **æ—¶é—´çº¿äº‹ä»¶** (`TimelineEvent`): å¸¦æ—¥æœŸå’Œé‡è¦æ€§çš„äº‹ä»¶åºåˆ—
- **å› æœå…³ç³»** (`CausalRelation`): åŸå› -ç»“æœå…³ç³»ï¼Œå«ç½®ä¿¡åº¦
- **çŸ¥è¯†å›¾è°±** (`KnowledgeGraph`): å®ä½“å’Œå…³ç³»çš„å›¾ç»“æ„
- **å±‚çº§å›¾** (`HierarchyGraph`): å±•ç¤ºæº¯æºæ·±åº¦çš„æ ‘å½¢ç»“æ„

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯ (Vue 3)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ChatView    â”‚  â”‚ NewsTrace    â”‚  â”‚   Sidebar    â”‚  â”‚
â”‚  â”‚  (å¯¹è¯ç•Œé¢)   â”‚  â”‚  Result      â”‚  â”‚  (å†å²è®°å½•)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTP/REST API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åç«¯ (FastAPI)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              API Routes                          â”‚   â”‚
â”‚  â”‚  - POST /trace/async (åˆ›å»ºæº¯æºä»»åŠ¡)              â”‚   â”‚
â”‚  â”‚  - GET /trace/status/{task_id} (æŸ¥è¯¢çŠ¶æ€)        â”‚   â”‚
â”‚  â”‚  - POST /trace/cancel/{task_id} (å–æ¶ˆä»»åŠ¡)       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          NewsTraceAgent                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚  System      â”‚      â”‚  LLM         â”‚          â”‚   â”‚
â”‚  â”‚  â”‚  Prompt      â”‚â”€â”€â”€â”€â”€â–¶â”‚  (mira)      â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â”‚                              â”‚                   â”‚   â”‚
â”‚  â”‚                              â”‚ å·¥å…·è°ƒç”¨å†³ç­–       â”‚   â”‚
â”‚  â”‚                              â–¼                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚            Tools (å·¥å…·é›†)                  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚GoogleSearchâ”‚  â”‚WebScraper  â”‚          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚(Serper API)â”‚  â”‚(Playwright)â”‚          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Agent è®¾è®¡

### NewsTraceAgent æ¶æ„

`NewsTraceAgent` æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œè´Ÿè´£åè°ƒ LLM å’Œå·¥å…·æ‰§è¡Œæº¯æºä»»åŠ¡ã€‚

#### åˆå§‹åŒ–

```python
class NewsTraceAgent:
    def __init__(self):
        # 1. åˆå§‹åŒ– LLM (ä½¿ç”¨ mira çš„ OpenRouterLLM)
        llm_args = OpenAIArgs(
            api_key=settings.get_api_key(),
            base_url=settings.get_base_url(),
            model=settings.model,
            temperature=0.7,
            max_completion_tokens=4000
        )
        self.llm = OpenRouterLLM(args=llm_args)
        
        # 2. æ³¨å†Œå·¥å…·
        self.tools = [
            GoogleSearch,      # å¿…éœ€å·¥å…·
            WebScraper,        # å¯é€‰ï¼ˆéœ€è¦ Playwrightï¼‰
            DatabaseSearch     # å¯é€‰ï¼ˆéœ€è¦ SQLAlchemyï¼‰
        ]
        
        # 3. ç³»ç»Ÿæç¤ºè¯ï¼ˆå®šä¹‰ Agent è¡Œä¸ºï¼‰
        self.system_prompt = """..."""
```

#### å·¥ä½œæµç¨‹

```python
async def trace_news(claim: str, max_iterations: int = 10) -> TraceResult:
    """
    å¤šè½®è¿­ä»£æº¯æºæµç¨‹ï¼š
    
    1. åˆå§‹åŒ–æ¶ˆæ¯: SystemMessage + HumanMessage
    2. å¾ªç¯è¿­ä»£ (æœ€å¤š max_iterations æ¬¡):
       a. LLM å†³ç­–: è°ƒç”¨ forward() è·å–å·¥å…·è°ƒç”¨
       b. å·¥å…·æ‰§è¡Œ: æ‰§è¡Œ GoogleSearch/WebScraper
       c. ç»“æœæ•´åˆ: å°†å·¥å…·ç»“æœåŠ å…¥æ¶ˆæ¯æµ
       d. æ£€æŸ¥å–æ¶ˆ: å¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œç«‹å³åœæ­¢
    3. æå–æ¥æº: ä» ToolMessage ä¸­æå– NewsSource
    4. æ„å»ºåˆ†æ:
       - æ—¶é—´çº¿ (_extract_timeline)
       - å› æœå…³ç³» (_extract_causal_relations)
       - çŸ¥è¯†å›¾è°± (_build_knowledge_graph)
       - å±‚çº§å›¾ (_build_hierarchy_graph)
    5. è®¡ç®—ç½®ä¿¡åº¦: åŸºäºæ¥æºæ•°é‡å’Œç›¸å…³æ€§
    6. è¿”å› TraceResult
    """
```

### æµç¨‹ç¤ºä¾‹
```
# æ ¹æ®æ·±åº¦è®¾ç½®æœ€å¤§è¿­ä»£æ¬¡æ•°
max_iterations_map = {
    1: 3,   # æ·±åº¦1: 3è½®
    2: 6,   # æ·±åº¦2: 6è½®ï¼ˆé»˜è®¤ï¼‰
    3: 9,   # æ·±åº¦3: 9è½®
    4: 12   # æ·±åº¦4: 12è½®
}

è¿­ä»£ 1: 
  â†’ LLM: "éœ€è¦æœç´¢åˆå§‹æ¥æº"
  â†’ è°ƒç”¨ GoogleSearch("æŸç§‘æŠ€å…¬å¸å®£å¸ƒè·å¾—æ–°ä¸€è½®èèµ„")
  â†’ è¿”å› 10 æ¡æœç´¢ç»“æœ

è¿­ä»£ 2:
  â†’ LLM: "éœ€è¦æŠ“å–è¿™äº› URL çš„è¯¦ç»†å†…å®¹"
  â†’ è°ƒç”¨ WebScraper(url1), WebScraper(url2), ... (5-10ä¸ª)
  â†’ è¿”å›å®Œæ•´æ–‡ç« å†…å®¹

è¿­ä»£ 3:
  â†’ LLM: "ä»å†…å®¹ä¸­å‘ç°å…³é”®äº‹ä»¶ï¼š2024å¹´1æœˆ15æ—¥ï¼ŒAè½®èèµ„"
  â†’ è°ƒç”¨ GoogleSearch("æŸç§‘æŠ€å…¬å¸ Aè½®èèµ„ 2024å¹´1æœˆ")
  â†’ è¿”å›æ›´ç²¾ç¡®çš„æœç´¢ç»“æœ

è¿­ä»£ 4:
  â†’ LLM: "éœ€è¦æŠ“å–è¿™äº›æ–°å‘ç°çš„ URL"
  â†’ è°ƒç”¨ WebScraper(url11), WebScraper(url12), ...
  â†’ ç»§ç»­æ”¶é›†ä¿¡æ¯

è¿­ä»£ 5:
  â†’ LLM: "å‘ç°åŸå§‹æ¥æºæ˜¯å…¬å¸å®˜ç½‘å…¬å‘Š"
  â†’ è°ƒç”¨ WebScraper("å…¬å¸å®˜ç½‘å…¬å‘ŠURL")
  â†’ ç¡®è®¤åŸå§‹æ¥æº

è¿­ä»£ 6:
  â†’ LLM: "ä¿¡æ¯å·²å……åˆ†ï¼Œå¯ä»¥å¼€å§‹åˆ†æ"
  â†’ æ— å·¥å…·è°ƒç”¨ï¼Œè¿”å›æœ€ç»ˆåˆ†æ
  â†’ ç³»ç»Ÿæ£€æµ‹åˆ°æ— å·¥å…·è°ƒç”¨ï¼Œåœæ­¢å¾ªç¯
```

#### å…³é”®ç‰¹æ€§

1. **å¤šè½®è¿­ä»£**: é€šè¿‡ `max_iterations` æ§åˆ¶è¿­ä»£æ¬¡æ•°ï¼Œæ¯æ¬¡è¿­ä»£ LLM å¯ä»¥è°ƒç”¨å¤šä¸ªå·¥å…·
2. **å–æ¶ˆæ”¯æŒ**: é€šè¿‡ `check_cancelled` å›è°ƒå‡½æ•°æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆ
3. **è¿›åº¦ç›‘æ§**: åœ¨å…³é”®æ­¥éª¤æ›´æ–°ä»»åŠ¡è¿›åº¦ï¼ˆ0-100%ï¼‰
4. **é”™è¯¯å¤„ç†**: æ•è·å¼‚å¸¸å¹¶è¿”å›éƒ¨åˆ†ç»“æœï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

## å·¥å…·è®¾è®¡

### 1. GoogleSearch å·¥å…·

**ç”¨é€”**: é€šè¿‡ Serper API æœç´¢ Googleï¼Œè·å–ç›¸å…³æ–°é—»æ¥æº

**å®ç°**:

```python
class GoogleSearch(LLMTool):
    query: str = Field(..., description="Search query string")
    num_results: int = Field(default=10, ge=1, le=50)
    
    def __call__(self):
        # è°ƒç”¨ Serper API
        response = httpx.post(
            "https://google.serper.dev/search",
            headers={"X-API-KEY": settings.serper_api_key},
            json={"q": self.query, "num": self.num_results}
        )
        # è¿”å›ç»“æ„åŒ–ç»“æœ
        return {
            "success": True,
            "query": self.query,
            "results": [...],  # åŒ…å« title, url, snippet
            "total_results": len(results)
        }
```

**ç‰¹ç‚¹**:
- ä½¿ç”¨ Serper APIï¼Œæ— éœ€å¤„ç†åçˆ¬è™«
- è¿”å›ç»“æ„åŒ–æ•°æ®ï¼ˆæ ‡é¢˜ã€URLã€æ‘˜è¦ï¼‰
- æ”¯æŒè‡ªå®šä¹‰ç»“æœæ•°é‡

### 2. WebScraper å·¥å…·

**ç”¨é€”**: ä½¿ç”¨ Playwright æŠ“å–ç½‘é¡µå®Œæ•´å†…å®¹

**å®ç°**:

```python
class WebScraper(LLMTool):
    url: str = Field(..., description="URL to scrape")
    extract_content: bool = Field(default=True)
    
    def __call__(self):
        # ä½¿ç”¨ Playwright æ‰“å¼€é¡µé¢
        with sync_playwright() as p:
            browser = p.chromium.launch(headless=True)
            page = browser.new_page()
            page.goto(self.url)
            
            # æå–å†…å®¹
            content = page.evaluate("""
                // æå–ä¸»å†…å®¹ã€æ ‡é¢˜ã€ä½œè€…ã€æ—¥æœŸç­‰
            """)
            
            return {
                "success": True,
                "url": self.url,
                "title": ...,
                "content": ...,  # å®Œæ•´æ–‡ç« å†…å®¹ï¼ˆæœ€å¤š 15000 å­—ç¬¦ï¼‰
                "author": ...,
                "published_date": ...,
                "headings": [...],
                "key_paragraphs": [...]
            }
```

**ç‰¹ç‚¹**:
- **æ”¯æŒåŠ¨æ€ç½‘é¡µ**: Playwright å¯ä»¥æ‰§è¡Œ JavaScriptï¼Œå¤„ç† SPA
- **æ™ºèƒ½å†…å®¹æå–**: è‡ªåŠ¨è¯†åˆ«æ–‡ç« ä¸»å†…å®¹ï¼Œè¿‡æ»¤å¹¿å‘Šå’Œå¯¼èˆª
- **å…ƒæ•°æ®æå–**: æå–æ ‡é¢˜ã€ä½œè€…ã€å‘å¸ƒæ—¥æœŸç­‰ç»“æ„åŒ–ä¿¡æ¯
- **å®¹é”™å¤„ç†**: è¶…æ—¶ã€ç½‘ç»œé”™è¯¯ç­‰å¼‚å¸¸æƒ…å†µæœ‰å®Œå–„çš„é”™è¯¯å¤„ç†
- **åŒæ­¥/å¼‚æ­¥æ”¯æŒ**: æ ¹æ®ç¯å¢ƒè‡ªåŠ¨é€‰æ‹©åŒæ­¥æˆ–å¼‚æ­¥ API

### 3. å·¥å…·åä½œæµç¨‹

```
ç”¨æˆ·è¾“å…¥: "æŸç§‘æŠ€å…¬å¸å®£å¸ƒè·å¾—æ–°ä¸€è½®èèµ„"
  â†“
LLM å†³ç­–: è°ƒç”¨ GoogleSearch("æŸç§‘æŠ€å…¬å¸å®£å¸ƒè·å¾—æ–°ä¸€è½®èèµ„")
  â†“
GoogleSearch: è¿”å› 10 æ¡æœç´¢ç»“æœï¼ˆåŒ…å« URLï¼‰
  â†“
LLM å†³ç­–: åˆ†æç»“æœï¼Œé€‰æ‹©æœ€ç›¸å…³çš„ URL
  â†“
LLM å†³ç­–: è°ƒç”¨ WebScraper(url="https://tech.sina.cn/...")
  â†“
WebScraper: ä½¿ç”¨ Playwright æŠ“å–å®Œæ•´å†…å®¹
  â†“
LLM åˆ†æ: åŸºäºæŠ“å–å†…å®¹è¿›è¡Œæ›´æ·±å…¥çš„æœç´¢
  â†“
... (å¤šè½®è¿­ä»£)
  â†“
æœ€ç»ˆç»“æœ: ç»¼åˆæ‰€æœ‰æ¥æºç”Ÿæˆ TraceResult
```

## ç»“æ„åŒ–è¾“å‡º

ç³»ç»Ÿä½¿ç”¨ **Pydantic** å’Œ **mira çš„ LLMJson** å®ç°å¼ºç±»å‹ç»“æ„åŒ–è¾“å‡ºï¼Œç¡®ä¿ LLM è¿”å›çš„æ•°æ®ç¬¦åˆé¢„æœŸæ ¼å¼ã€‚

### ç»“æ„åŒ–è¾“å‡ºæ¨¡å‹

#### 1. TimelineOutput

```python
class TimelineOutput(LLMJson):
    events: List[TimelineEvent]

class TimelineEvent(BaseModel):
    date: Optional[str]
    event: str
    source_url: Optional[str]
    importance: Optional[str]  # high, medium, low
```

**ä½¿ç”¨åœºæ™¯**: ä»æ”¶é›†çš„ä¿¡æ¯ä¸­æå–æ—¶é—´çº¿äº‹ä»¶

```python
timeline_response = await self.llm.forward(
    messages=timeline_messages,
    tools=[],
    response_format=TimelineOutput,  # æŒ‡å®šè¾“å‡ºæ ¼å¼
    max_completion_tokens=3000
)
```

#### 2. CausalRelationsOutput

```python
class CausalRelationsOutput(LLMJson):
    relations: List[CausalRelation]

class CausalRelation(BaseModel):
    cause: str
    effect: str
    relationship_type: str  # direct, indirect, correlation
    confidence: float  # 0.0-1.0
    evidence: Optional[str]
```

**ä½¿ç”¨åœºæ™¯**: è¯†åˆ«äº‹ä»¶ä¹‹é—´çš„å› æœå…³ç³»

#### 3. KnowledgeGraphOutput

```python
class KnowledgeGraphOutput(LLMJson):
    nodes: List[KnowledgeGraphNode]
    edges: List[KnowledgeGraphEdge]

class KnowledgeGraphNode(BaseModel):
    id: str
    label: str
    type: str  # person, organization, location, concept, event
    properties: Optional[Dict[str, Any]]

class KnowledgeGraphEdge(BaseModel):
    source: str
    target: str
    relationship: str
    weight: Optional[float]  # 0.0-1.0
```

**ä½¿ç”¨åœºæ™¯**: æ„å»ºå®ä½“å’Œå…³ç³»çš„çŸ¥è¯†å›¾è°±

#### 4. HierarchyGraphOutput

```python
class HierarchyGraphOutput(LLMJson):
    root_id: str
    nodes: List[HierarchyNode]
    max_depth: int

class HierarchyNode(BaseModel):
    id: str
    label: str
    level: int  # 0=root, 1, 2, 3, 4...
    parent_id: Optional[str]
    source_urls: List[str]
    description: Optional[str]
```

**ä½¿ç”¨åœºæ™¯**: æ„å»ºå±•ç¤ºæº¯æºæ·±åº¦çš„å±‚æ¬¡ç»“æ„

### JSON è§£æå®¹é”™

ç”±äº LLM å¯èƒ½è¿”å›ä¸å®Œæ•´çš„ JSONï¼Œç³»ç»Ÿå®ç°äº†æ™ºèƒ½ä¿®å¤æœºåˆ¶ï¼š

```python
def _try_fix_incomplete_json(json_str: str):
    """
    ä¿®å¤ä¸å®Œæ•´çš„ JSON:
    1. è¡¥å…¨ç¼ºå¤±çš„æ‹¬å· {}
    2. è¡¥å…¨ç¼ºå¤±çš„æ–¹æ‹¬å· []
    3. å¤„ç†æœªé—­åˆçš„å­—ç¬¦ä¸²
    4. ç§»é™¤æœ«å°¾çš„é€—å·
    5. å¦‚æœä¿®å¤å¤±è´¥ï¼Œå°è¯•æå–éƒ¨åˆ†æœ‰æ•ˆæ•°æ®
    """
```

## çˆ¬è™«ç‰¹æ€§

### Playwright çš„ä¼˜åŠ¿

1. **çœŸå®æµè§ˆå™¨ç¯å¢ƒ**: ä½¿ç”¨ Chromium å†…æ ¸ï¼Œå®Œå…¨æ¨¡æ‹ŸçœŸå®æµè§ˆå™¨
2. **JavaScript æ‰§è¡Œ**: å¯ä»¥å¤„ç† Reactã€Vue ç­‰ SPA åº”ç”¨
3. **ç­‰å¾…æœºåˆ¶**: è‡ªåŠ¨ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆï¼Œé¿å…ç«æ€æ¡ä»¶
4. **ç½‘ç»œæ‹¦æˆª**: å¯ä»¥æ‹¦æˆªå’Œä¿®æ”¹ç½‘ç»œè¯·æ±‚
5. **æˆªå›¾å’Œ PDF**: æ”¯æŒé¡µé¢æˆªå›¾å’Œ PDF å¯¼å‡ºï¼ˆç”¨äºè°ƒè¯•ï¼‰

### å†…å®¹æå–ç­–ç•¥

```python
# 1. ç­‰å¾…é¡µé¢åŠ è½½
page.goto(url, wait_until="networkidle")

# 2. æå–ä¸»å†…å®¹
content = page.evaluate("""
    // ç­–ç•¥ 1: æŸ¥æ‰¾ <article> æ ‡ç­¾
    // ç­–ç•¥ 2: æŸ¥æ‰¾æœ€å¤§æ–‡æœ¬å—
    // ç­–ç•¥ 3: ä½¿ç”¨å¸¸è§å†…å®¹é€‰æ‹©å™¨
""")

# 3. æå–å…ƒæ•°æ®
title = page.title()
author = page.query_selector('meta[name="author"]')
published_date = page.query_selector('time[datetime]')

# 4. æå–ç»“æ„åŒ–ä¿¡æ¯
headings = page.query_selector_all('h1, h2, h3')
paragraphs = page.query_selector_all('p')
```

### æ€§èƒ½ä¼˜åŒ–

1. **å¹¶å‘æ§åˆ¶**: é™åˆ¶åŒæ—¶æ‰“å¼€çš„æµè§ˆå™¨å®ä¾‹æ•°é‡
2. **è¶…æ—¶è®¾ç½®**: ä¸ºæ¯ä¸ªé¡µé¢è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
3. **èµ„æºè¿‡æ»¤**: å¯ä»¥é˜»æ­¢å›¾ç‰‡ã€CSS ç­‰èµ„æºåŠ è½½ï¼ŒåŠ å¿«é€Ÿåº¦
4. **ç¼“å­˜æœºåˆ¶**: å¯ä»¥ç¼“å­˜å·²æŠ“å–çš„é¡µé¢å†…å®¹

### é”™è¯¯å¤„ç†

```python
try:
    # å°è¯•æŠ“å–
    result = scrape_page(url)
except TimeoutError:
    # è¶…æ—¶é‡è¯•
    result = scrape_page(url, timeout=60)
except Exception as e:
    # è®°å½•é”™è¯¯ï¼Œè¿”å›éƒ¨åˆ†ç»“æœ
    logger.error(f"Scraping failed: {e}")
    return {"success": False, "error": str(e)}
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- Node.js 16+
- Playwright (å®‰è£…åéœ€è¦è¿è¡Œ `playwright install`)

### åç«¯è®¾ç½®

1. **å®‰è£…ä¾èµ–**

```bash
cd backend
pip install -r requirements.txt

# å®‰è£… Playwright æµè§ˆå™¨
playwright install chromium
```

2. **é…ç½®ç¯å¢ƒå˜é‡**

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```env
# LLM é…ç½®
API_KEY=your_api_key
BASE_URL=https://ark.cn-beijing.volces.com/api/v3
MODEL=doubao/ep-20250615233434-wps9w

# Serper API (Google æœç´¢)
SERPER_API_KEY=your_serper_api_key

# æ•°æ®åº“ (å¯é€‰)
DATABASE_URL=sqlite:///./news_trace.db
```

3. **å¯åŠ¨æœåŠ¡**

```bash
python run.py
# æˆ–
uvicorn app.main:app --reload --port 8000
```

### å‰ç«¯è®¾ç½®

1. **å®‰è£…ä¾èµ–**

```bash
cd frontend/new_trace_frontend
npm install
```

2. **å¯åŠ¨å¼€å‘æœåŠ¡å™¨**

```bash
npm run dev
```

3. **è®¿é—®åº”ç”¨**

æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:5173`

## é¡¹ç›®ç»“æ„

```
finhub/new_trace/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ agent/
â”‚   â”‚   â”‚   â”œâ”€â”€ news_trace_agent.py    # æ–°é—»æº¯æº Agent
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes.py               # FastAPI è·¯ç”±
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”‚   â”œâ”€â”€ google_search.py        # Google æœç´¢å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ web_scraper.py          # ç½‘é¡µçˆ¬è™«å·¥å…·
â”‚   â”‚   â”‚   â”œâ”€â”€ database_search.py      # æ•°æ®åº“æœç´¢å·¥å…·ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py                   # Pydantic æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ config.py                   # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ main.py                     # FastAPI åº”ç”¨å…¥å£
â”‚   â”‚   â””â”€â”€ database.py                # æ•°æ®åº“è¿æ¥ï¼ˆå¯é€‰ï¼‰
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”œâ”€â”€ run.py                          # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ README.md
â”‚
â””â”€â”€ frontend/
    â””â”€â”€ new_trace_frontend/
        â”œâ”€â”€ src/
        â”‚   â”œâ”€â”€ views/
        â”‚   â”‚   â””â”€â”€ Chat/
        â”‚   â”‚       â””â”€â”€ ChatView.vue     # ä¸»èŠå¤©ç•Œé¢
        â”‚   â”œâ”€â”€ components/
        â”‚   â”‚   â”œâ”€â”€ NewsTraceResult.vue # ç»“æœå±•ç¤ºç»„ä»¶
        â”‚   â”‚   â””â”€â”€ sidebar.vue         # ä¾§è¾¹æ 
        â”‚   â”œâ”€â”€ api/
        â”‚   â”‚   â””â”€â”€ agent.js             # API è°ƒç”¨
        â”‚   â”œâ”€â”€ utils/
        â”‚   â”‚   â”œâ”€â”€ chatHistory.js      # å†å²è®°å½•ç®¡ç†
        â”‚   â”‚   â””â”€â”€ request.js          # HTTP è¯·æ±‚å°è£…
        â”‚   â””â”€â”€ main.js
        â”œâ”€â”€ package.json
        â””â”€â”€ vite.config.js
```

## API æ–‡æ¡£

### åˆ›å»ºæº¯æºä»»åŠ¡

```http
POST /trace/async
Content-Type: application/json

{
  "claim": "æŸç§‘æŠ€å…¬å¸å®£å¸ƒè·å¾—æ–°ä¸€è½®èèµ„",
  "max_depth": 2
}
```

**å“åº”**:

```json
{
  "task_id": "uuid-string",
  "status": "pending"
}
```

### æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€

```http
GET /trace/status/{task_id}
```

**å“åº”**:

```json
{
  "task_id": "uuid-string",
  "status": "processing",
  "progress": 0.65,
  "message": "æ­£åœ¨æ„å»ºçŸ¥è¯†å›¾è°±...",
  "result": null
}
```

### å–æ¶ˆä»»åŠ¡

```http
POST /trace/cancel/{task_id}
```

**å“åº”**:

```json
{
  "success": true,
  "message": "ä»»åŠ¡å·²å–æ¶ˆ"
}
```

### è·å–å®Œæ•´ç»“æœ

å½“ `status` ä¸º `completed` æ—¶ï¼Œ`result` å­—æ®µåŒ…å«å®Œæ•´çš„ `TraceResult`:

```json
{
  "task_id": "uuid-string",
  "status": "completed",
  "progress": 1.0,
  "result": {
    "original_claim": "...",
    "sources": [...],
    "confidence": 0.96,
    "summary": "...",
    "timeline": [...],
    "causal_relations": [...],
    "knowledge_graph": {...},
    "hierarchy_graph": {...}
  }
}
```

## å‰ç«¯ç•Œé¢

### ä¸»è¦åŠŸèƒ½

1. **å¯¹è¯ç•Œé¢** (`ChatView.vue`)
   - Agent é€‰æ‹©ï¼ˆæ–°é—»æº¯æºã€é‡‘èåˆ†æç­‰ï¼‰
   - æ¶ˆæ¯è¾“å…¥å’Œå‘é€
   - å®æ—¶è¿›åº¦æ˜¾ç¤º
   - ä»»åŠ¡æš‚åœ/å–æ¶ˆ

2. **ç»“æœå±•ç¤º** (`NewsTraceResult.vue`)
   - **æ¥æºåˆ—è¡¨**: æ˜¾ç¤ºæ‰€æœ‰æ‰¾åˆ°çš„æ–°é—»æ¥æº
   - **æ—¶é—´çº¿**: å¯è§†åŒ–æ—¶é—´çº¿äº‹ä»¶
   - **å› æœå…³ç³»**: å±•ç¤ºäº‹ä»¶é—´çš„å› æœå…³ç³»
   - **çŸ¥è¯†å›¾è°±**: äº¤äº’å¼çŸ¥è¯†å›¾è°±ï¼ˆä½¿ç”¨ vis.jsï¼‰
   - **å±‚çº§å›¾**: å±•ç¤ºæº¯æºæ·±åº¦çš„æ ‘å½¢ç»“æ„

3. **å†å²è®°å½•** (`sidebar.vue`)
   - æŸ¥çœ‹å†å²å¯¹è¯
   - æœç´¢å†å²è®°å½•
   - åˆ é™¤å¯¹è¯

### å¯è§†åŒ–ç‰¹æ€§

- **çŸ¥è¯†å›¾è°±**: 
  - èŠ‚ç‚¹ç±»å‹é¢œè‰²åŒºåˆ†ï¼ˆäººç‰©ã€ç»„ç»‡ã€åœ°ç‚¹ã€æ¦‚å¿µã€äº‹ä»¶ï¼‰
  - äº¤äº’å¼æ‹–æ‹½å’Œç¼©æ”¾
  - ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…
  
- **å±‚çº§å›¾**:
  - æ ‘å½¢å¸ƒå±€å±•ç¤ºæº¯æºæ·±åº¦
  - æ”¯æŒå›¾å½¢å’Œåˆ—è¡¨ä¸¤ç§è§†å›¾
  - æ˜¾ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ¥æºæ•°é‡

- **æ—¶é—´çº¿**:
  - æŒ‰æ—¥æœŸæ’åºçš„äº‹ä»¶åˆ—è¡¨
  - é‡è¦æ€§æ ‡è®°ï¼ˆé«˜/ä¸­/ä½ï¼‰

## æŠ€æœ¯äº®ç‚¹

### 1. Agent æ¶æ„è®¾è®¡

- **å·¥å…·è§£è€¦**: å·¥å…·ä½œä¸ºç‹¬ç«‹ç±»ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤
- **æ¶ˆæ¯æµç®¡ç†**: é€šè¿‡ AIMessage å’Œ ToolMessage å®ç°å·¥å…·è°ƒç”¨å’Œç»“æœä¼ é€’
- **å¤šè½®è¿­ä»£**: æ”¯æŒå¤æ‚çš„å¤šæ­¥éª¤æº¯æºæµç¨‹

### 2. çˆ¬è™«æŠ€æœ¯

- **åŠ¨æ€ç½‘é¡µå¤„ç†**: Playwright å¯ä»¥å¤„ç† JavaScript æ¸²æŸ“çš„é¡µé¢
- **æ™ºèƒ½å†…å®¹æå–**: è‡ªåŠ¨è¯†åˆ«æ–‡ç« ä¸»å†…å®¹ï¼Œè¿‡æ»¤æ— å…³ä¿¡æ¯
- **å®¹é”™æœºåˆ¶**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

### 3. ç»“æ„åŒ–è¾“å‡º

- **å¼ºç±»å‹éªŒè¯**: ä½¿ç”¨ Pydantic ç¡®ä¿æ•°æ®æ ¼å¼æ­£ç¡®
- **JSON ä¿®å¤**: æ™ºèƒ½ä¿®å¤ LLM è¿”å›çš„ä¸å®Œæ•´ JSON
- **ç±»å‹å®‰å…¨**: ä»æ¨¡å‹å®šä¹‰åˆ° API å“åº”å…¨ç¨‹ç±»å‹æ£€æŸ¥

### 4. å‰ç«¯ä½“éªŒ

- **å®æ—¶æ›´æ–°**: WebSocket æˆ–è½®è¯¢å®ç°å®æ—¶è¿›åº¦æ›´æ–°
- **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨ Vue 3 Composition API ç®¡ç†å¤æ‚çŠ¶æ€
- **å¯è§†åŒ–**: ä¸°å¯Œçš„å›¾è¡¨å’Œäº¤äº’å¼ç»„ä»¶

## æœªæ¥æ”¹è¿›

- [ ] æ”¯æŒæ›´å¤šæ•°æ®æºï¼ˆTwitterã€Reddit ç­‰ï¼‰
- [ ] å®ç°æ›´æ™ºèƒ½çš„å†…å®¹å»é‡
- [ ] æ·»åŠ æ¥æºæƒå¨æ€§è¯„åˆ†
- [ ] æ”¯æŒæ‰¹é‡æº¯æºä»»åŠ¡
- [ ] æ·»åŠ å¯¼å‡ºåŠŸèƒ½ï¼ˆPDFã€JSONï¼‰
- [ ] å®ç°ç”¨æˆ·è®¤è¯å’Œæƒé™ç®¡ç†
- [ ] æ·»åŠ æ•°æ®åº“æŒä¹…åŒ–
- [ ] ä¼˜åŒ–çˆ¬è™«æ€§èƒ½ï¼ˆå¹¶å‘ã€ç¼“å­˜ï¼‰


